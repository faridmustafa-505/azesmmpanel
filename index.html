<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giri≈ü | Mobil T…ôsdiql…ôm…ô</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Gizli recaptcha √º√ß√ºn stil */
        .grecaptcha-badge { 
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden relative">
        <div class="bg-blue-600 p-6 text-center">
            <h1 class="text-white text-2xl font-bold">Xo≈ü G…ôlmisiniz</h1>
            <p class="text-blue-100 text-sm mt-1">Hesabƒ±nƒ±za daxil olun</p>
        </div>

        <div class="p-8">
            <!-- X…ôta Mesajƒ± -->
            <div id="error-message" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 border border-red-200 flex items-center">
                <i class="fas fa-exclamation-circle mr-2 flex-shrink-0"></i>
                <span id="error-text" class="break-words">X…ôta ba≈ü verdi.</span>
            </div>

            <!-- Addƒ±m 1 -->
            <div id="step-phone">
                <label class="block text-gray-700 text-sm font-bold mb-2">Telefon N√∂mr…ôsi</label>
                <div class="flex relative rounded-md shadow-sm">
                    <span class="inline-flex items-center px-4 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm font-medium">
                        üá¶üáø +994
                    </span>
                    <input type="tel" id="phone-number" 
                        class="flex-1 min-w-0 block w-full px-4 py-3 rounded-none rounded-r-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm outline-none transition" 
                        placeholder="50 123 45 67"
                        maxlength="9"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                
                <!-- ReCaptcha Container -->
                <div id="recaptcha-container" class="mt-4 flex justify-center min-h-[78px]"></div>

                <!-- D√úZ∆èLƒ∞≈û: ID 'send-code-btn' yerin…ô 'send-btn' edildi -->
                <button id="send-btn" onclick="sendOTP()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex justify-center items-center shadow-md">
                    <span id="send-text">Kodu G√∂nd…ôr</span>
                    <span id="send-loader" class="loader ml-2 hidden"></span>
                </button>
            </div>

            <!-- Addƒ±m 2 -->
            <div id="step-otp" class="hidden">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-3">
                        <i class="fas fa-sms text-xl"></i>
                    </div>
                    <h2 class="text-gray-800 font-bold">Kodu daxil edin</h2>
                    <p class="text-gray-500 text-sm mt-1">
                        <span id="sent-number" class="font-medium">+994...</span> n√∂mr…ôsin…ô SMS g√∂nd…ôrildi.
                    </p>
                </div>

                <input type="text" id="otp-code" 
                    class="block w-full text-center tracking-[0.5em] text-2xl font-bold px-4 py-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 outline-none transition mb-4" 
                    placeholder="123456"
                    maxlength="6"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">

                <button id="verify-btn" onclick="verifyOTP()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex justify-center items-center shadow-md">
                    <span id="verify-text">T…ôsdiql…ô</span>
                    <span id="verify-loader" class="loader ml-2 hidden"></span>
                </button>
                
                <button onclick="resetForm()" class="w-full mt-3 text-gray-500 text-sm hover:text-gray-700 underline">
                    N√∂mr…ôni d…ôyi≈ü
                </button>
            </div>

            <!-- Uƒüur -->
            <div id="step-success" class="hidden text-center py-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 text-green-600 mb-4 animate-bounce">
                    <i class="fas fa-check text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Uƒüurlu Giri≈ü!</h2>
                <p class="text-gray-600 mt-2">Sistem…ô xo≈ü g…ôldiniz.</p>
                <p id="user-uid" class="text-xs text-gray-400 mt-4 break-all font-mono bg-gray-50 p-2 rounded"></p>
                <button onclick="auth.signOut().then(() => location.reload())" class="mt-6 px-6 py-2 border border-red-500 text-red-500 rounded-full hover:bg-red-50 transition">
                    √áƒ±xƒ±≈ü et
                </button>
            </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-4 text-center border-t border-gray-100">
            <p class="text-xs text-gray-400">&copy; 2024 AzeSmmPanel</p>
        </div>
    </div>

    <!-- Firebase SDK v10 (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <script>
        // Sizin Konfiqurasiya
        const firebaseConfig = {
            apiKey: "AIzaSyALBhMZoDFowkTROYa1awwo-3FbvmnJJpQ",
            authDomain: "azesmmpanel0.firebaseapp.com",
            databaseURL: "https://azesmmpanel0-default-rtdb.firebaseio.com",
            projectId: "azesmmpanel0",
            storageBucket: "azesmmpanel0.firebasestorage.app",
            messagingSenderId: "74060568870",
            appId: "1:74060568870:web:5f5aed2cbef031c2c149e7"
        };

        // Firebase-i i≈ü…ô salƒ±rƒ±q
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        auth.languageCode = 'az'; // SMS dilini Az…ôrbaycan dili edirik

        // D…ôyi≈ü…ônl…ôr
        let confirmationResult = null;
        const phoneInput = document.getElementById('phone-number');
        const otpInput = document.getElementById('otp-code');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // S…ôhif…ô y√ºkl…ôn…ônd…ô ReCaptcha-nƒ± hazƒ±rlayƒ±rƒ±q
        window.onload = function() {
            setupRecaptcha();
        };

        function setupRecaptcha() {
            // ∆èg…ôr k√∂hn…ô widget varsa, t…ômizl…ôyirik ki, x…ôta verm…ôsin
            if (window.recaptchaVerifier) {
                try {
                    window.recaptchaVerifier.clear();
                    window.recaptchaVerifier = null;
                } catch(e) { console.log("Recaptcha clear error", e); }
            }
            document.getElementById('recaptcha-container').innerHTML = '';

            // Yeni widget yaradƒ±lƒ±r
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'normal', // G√∂r√ºn…ôn "M…ôn robot deyil…ôm" qutusu
                'callback': (response) => {
                    console.log("ReCaptcha t…ôsdiql…ôndi");
                    hideError();
                },
                'expired-callback': () => {
                    showError("ReCaptcha vaxtƒ± bitdi. Yenid…ôn c…ôhd edin.");
                }
            });
            
            try {
                window.recaptchaVerifier.render();
            } catch (e) {
                console.error("Render x…ôtasƒ±:", e);
            }
        }

        function sendOTP() {
            const phoneNumber = phoneInput.value.trim();
            if (phoneNumber.length < 9) {
                showError("N√∂mr…ôni d√ºzg√ºn daxil edin (m…ôs: 501234567)");
                return;
            }

            setLoading('send', true);
            hideError();

            const fullPhoneNumber = "+994" + phoneNumber;
            const appVerifier = window.recaptchaVerifier;

            auth.signInWithPhoneNumber(fullPhoneNumber, appVerifier)
                .then((result) => {
                    // Uƒüurlu SMS g√∂nd…ôrildi
                    window.confirmationResult = result;
                    setLoading('send', false);
                    
                    document.getElementById('step-phone').classList.add('hidden');
                    document.getElementById('step-otp').classList.remove('hidden');
                    document.getElementById('sent-number').innerText = fullPhoneNumber;
                }).catch((error) => {
                    setLoading('send', false);
                    console.error("Firebase Error:", error);
                    
                    // ReCaptcha-nƒ± sƒ±fƒ±rlayƒ±rƒ±q ki, istifad…ô√ßi yenid…ôn c…ôhd ed…ô bilsin
                    setupRecaptcha();

                    // X…ôtalarƒ± izah edirik
                    if (error.code === 'auth/invalid-phone-number') {
                        showError("N√∂mr…ô formatƒ± yanlƒ±≈üdƒ±r.");
                    } else if (error.code === 'auth/too-many-requests') {
                        showError("√áox sayda c…ôhd edildi. Bir az sonra yoxlayƒ±n.");
                    } else if (error.message.includes("401") || error.code === 'auth/network-request-failed') {
                        showError("API ƒ∞caz…ô x…ôtasƒ± (401). API Key yenil…ônm…ôsi √º√ß√ºn 5 d…ôqiq…ô g√∂zl…ôyin.");
                    } else if (error.message.includes("authorized domain")) {
                        showError("Domen icaz…ôsi h…ôl…ô aktivl…ô≈üm…ôyib. 1-2 d…ôqiq…ô g√∂zl…ôyin.");
                    } else {
                        showError("X…ôta: " + error.message);
                    }
                });
        }

        function verifyOTP() {
            const code = otpInput.value.trim();
            if (code.length !== 6) {
                showError("Kod 6 r…ôq…ômli olmalƒ±dƒ±r.");
                return;
            }

            setLoading('verify', true);
            hideError();

            window.confirmationResult.confirm(code).then((result) => {
                const user = result.user;
                setLoading('verify', false);
                document.getElementById('step-otp').classList.add('hidden');
                document.getElementById('step-success').classList.remove('hidden');
                document.getElementById('user-uid').innerText = "ID: " + user.uid;
            }).catch((error) => {
                setLoading('verify', false);
                console.error(error);
                showError("Kod yanlƒ±≈üdƒ±r.");
            });
        }

        function showError(msg) {
            errorDiv.classList.remove('hidden');
            errorText.innerText = msg;
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }

        function setLoading(type, isLoading) {
            const btn = document.getElementById(type + '-btn');
            
            // D√úZ∆èLƒ∞≈û: Element tapƒ±lmazsa x…ôta verm…ôm…ôsi √º√ß√ºn yoxlama
            if (!btn) {
                console.error(`Button with id ${type}-btn not found!`);
                return;
            }

            const text = document.getElementById(type + '-text');
            const loader = document.getElementById(type + '-loader');

            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                text.innerText = "G√∂zl…ôyin...";
                loader.classList.remove('hidden');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                text.innerText = type === 'send' ? "Kodu G√∂nd…ôr" : "T…ôsdiql…ô";
                loader.classList.add('hidden');
            }
        }

        function resetForm() {
            // S…ôhif…ôni tam yenil…ôyirik ki, h…ôr ≈üey sƒ±fƒ±rlansƒ±n
            location.reload();
        }
    </script>
</body>
</html>
